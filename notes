package com.citi.turnover.config;

import org.apache.hc.client5.http.classic.HttpClient;
import org.apache.hc.client5.http.impl.classic.HttpClients;
import org.apache.hc.client5.http.impl.io.PoolingHttpClientConnectionManagerBuilder;
import org.apache.hc.client5.http.ssl.SSLConnectionSocketFactoryBuilder;
import org.apache.hc.core5.ssl.SSLContexts;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.client.HttpComponentsClientHttpRequestFactory;
import org.springframework.web.client.RestTemplate;

import javax.net.ssl.SSLContext;
import java.io.FileInputStream;
import java.nio.file.Path;
import java.security.KeyStore;

@Configuration
public class HttpClientConfig {

    @Bean
    public RestTemplate oauthRestTemplate(
            @Value("${security.truststore.path}") String path,
            @Value("${security.truststore.password}") String password,
            @Value("${security.truststore.type:PKCS12}") String type) throws Exception {

        try (var in = new FileInputStream(Path.of(path).toFile())) {
            var trustStore = KeyStore.getInstance(type);
            trustStore.load(in, password.toCharArray());

            SSLContext sslContext = SSLContexts.custom()
                    .loadTrustMaterial(trustStore, null)
                    .build();

            var connectionManager = PoolingHttpClientConnectionManagerBuilder.create()
                    // ⚠ IntelliJ shows deprecation warning — safe until HttpClient 6
                    .setSSLSocketFactory(SSLConnectionSocketFactoryBuilder.create()
                            .setSslContext(sslContext)
                            .build())
                    .build();

            HttpClient httpClient = HttpClients.custom()
                    .setConnectionManager(connectionManager)
                    .evictExpiredConnections()
                    .build();

            return new RestTemplate(new HttpComponentsClientHttpRequestFactory(httpClient));
        }
    }
}
